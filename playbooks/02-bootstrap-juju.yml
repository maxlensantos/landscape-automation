---
- name: Install Juju Client and Bootstrap Controller
  hosts: all
  gather_facts: yes

  tasks:
    - name: Install Juju client from snap
      ansible.builtin.snap:
        name: juju
        classic: yes
      become: yes

    - name: Install LXD from snap
      ansible.builtin.snap:
        name: lxd
      become: yes

    - name: Initialize LXD (if necessary)
      ansible.builtin.command:
        cmd: lxd init --auto
      changed_when: true # The command --auto is safe for re-execution
      become: yes

    - name: Set LXD default profile to privileged mode
      ansible.builtin.command:
        cmd: lxc profile set default security.privileged true
      changed_when: true
      become: yes

    - name: Set LXD default profile to allow nesting
      ansible.builtin.command:
        cmd: lxc profile set default security.nesting true
      changed_when: true
      become: yes

    - name: Check for existing juju controllers
      ansible.builtin.command: sg lxd -c "juju controllers"
      register: juju_controllers_result
      changed_when: false
      become: no
      # This task is expected to fail if no controller exists. We treat that as a success.
      failed_when: "juju_controllers_result.rc != 0 and 'No controllers registered' not in juju_controllers_result.stderr"

    # --- Bootstrap para Ambiente de Teste ---
    - name: Bootstrap Juju on localhost for testing
      ansible.builtin.command: "sg lxd -c 'juju bootstrap localhost {{ controller_name }}'"
      when:
        - not (is_ha_cluster | bool)
        - "controller_name not in juju_controllers_result.stdout"
      changed_when: true
      become: no

    # --- Bootstrap para Ambiente de Produção (HA) ---
    - name: Bootstrap Juju on the first production node
      ansible.builtin.command: "sg lxd -c 'juju bootstrap localhost {{ controller_name }}'"
      when:
        - is_ha_cluster | bool
        - inventory_hostname == groups['landscape_vms'][0]
        - "controller_name not in juju_controllers_result.stdout"
      changed_when: true
      become: no

    - name: Inform other production nodes
      ansible.builtin.debug:
        msg: "Este nó não é o primário. Aguardando o bootstrap do controller no nó '{{ groups['landscape_vms'][0] }}'."
      when:
        - is_ha_cluster | bool
        - inventory_hostname != groups['landscape_vms'][0]
