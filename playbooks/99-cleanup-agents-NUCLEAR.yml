---
# playbooks/99-cleanup-agents-nuclear.yml
# LIMPEZA NUCLEAR DO JUJU - Remove TUDO para evitar "machine is already provisioned"
# Baseado em: /usr/sbin/remove-juju-services (equivalente em Ansible)
# 
# CRÃTICO: Execute isso ANTES de fazer novo bootstrap

- name: ðŸ”´ LIMPEZA NUCLEAR - Remove todos os serviÃ§os Juju
  hosts: ha_nodes
  remote_user: serpro
  become: yes
  gather_facts: yes

  vars:
    juju_snap_path: "/snap/juju"
    juju_data_dir: "/home/serpro/.local/share/juju"
    juju_services:
      - jujud
      - mongod
      - etcd

  pre_tasks:
    - name: âš ï¸  AVISO CRÃTICO
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘          ðŸ”´ LIMPEZA NUCLEAR DO JUJU EM PROGRESSO             â•‘
          â•‘                                                               
          â•‘  AÃ‡ÃƒO: Removendo TODOS os serviÃ§os, dados e config do Juju   â•‘
          â•‘  ALVO: {{ inventory_hostname }}                              â•‘
          â•‘  DATA: {{ ansible_date_time.iso8601 }}                       â•‘
          â•‘                                                               
          â•‘  âš ï¸  AVISO: Isto Ã© IRREVERSÃVEL. Dados locais serÃ£o perdidos.â•‘
          â•‘                                                               
          â•‘  Continuando em 5 segundos...                                
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    - name: Pausa antes de iniciar limpeza
      pause:
        seconds: 5

  tasks:
        # ============================================
        # 1. KILL ALL JUJU PROCESSES (ForÃ§a Bruta)
        # ============================================
        - name: ðŸ”´ PASSO 1 - Kill ALL Juju Processes (Aggressive)
          block:
            - name: Aggressively kill jujud, juju, and mongod processes
              shell: |
                sudo pkill -9 jujud juju mongod 2>/dev/null || true
                sleep 2
              changed_when: true
              ignore_errors: true
    
            - name: Remove juju and juju-db snap packages
              shell: |
                sudo snap remove juju --purge 2>/dev/null || true
                sudo snap remove juju-db --purge 2>/dev/null || true
                sleep 5
              changed_when: true
              ignore_errors: true
    
            - name: Remove juju data directories
              shell: |
                sudo rm -rf /var/lib/juju /var/run/juju /var/cache/juju /var/snap/juju* 2>/dev/null || true
                rm -rf ~/.local/share/juju ~/.juju ~/.cache/juju 2>/dev/null || true
              changed_when: true
              ignore_errors: true
    
            - name: Verify no jujud processes are running after aggressive kill
              shell: |
                if pgrep -f jujud > /dev/null; then
                  echo "âŒ ERRO: jujud ainda estÃ¡ rodando apÃ³s pkill!"
                  ps aux | grep jujud
                  exit 1
                fi
                echo "âœ“ Nenhum processo jujud rodando"
              changed_when: false
        - name: Kill mongod processes
          shell: |
            killall -9 mongod 2>/dev/null || true
            sleep 1
            ps aux | grep mongod | grep -v grep || echo "âœ“ mongod killado"
          changed_when: false
          ignore_errors: true

        - name: Kill etcd processes
          shell: |
            killall -9 etcd 2>/dev/null || true
            sleep 1
            ps aux | grep etcd | grep -v grep || echo "âœ“ etcd killado"
          changed_when: false
          ignore_errors: true

        - name: Verify all processes are dead
          shell: |
            sleep 2
            if pgrep -f jujud > /dev/null; then
              echo "âŒ ERRO: jujud ainda estÃ¡ rodando!"
              ps aux | grep jujud
              exit 1
            fi
            echo "âœ“ Todos os processos Juju foram killados"
          changed_when: false

    tags: kill_processes

    # ============================================ 
    # 2. REMOVE JUJU SNAP
    # ============================================ 
    - name: ðŸ”´ PASSO 2 - Remove Juju Snap Package
      block:
        - name: Remove juju snap
          shell: |
            snap remove juju --purge 2>&1 || true
            sleep 3
            echo "âœ“ Snap juju removido"
          changed_when: false

        - name: Verify snap is removed
          shell: |
            snap list 2>/dev/null | grep -q juju && \
              { echo "âŒ ERRO: juju snap ainda estÃ¡ instalado!"; exit 1; } || \
                          echo "âœ“ Snap juju verificado como removido"
                        changed_when: false
                  tags: remove_snap

    # ============================================ 
    # 3. REMOVE ALL JUJU DATA DIRECTORIES
    # ============================================ 
    - name: ðŸ”´ PASSO 3 - Remove Juju Data Directories
      block:
        - name: Remove /var/lib/juju
          shell: |
            rm -rf /var/lib/juju 2>&1 || true
            echo "âœ“ /var/lib/juju removido"
          changed_when: false

        - name: Remove juju home directory (user serpro)
          shell: |
            rm -rf /home/serpro/.local/share/juju 2>&1 || true
            echo "âœ“ ~/.local/share/juju removido"
          changed_when: false

        - name: Remove juju root directory
          shell: |
            rm -rf /root/.local/share/juju 2>&1 || true
            echo "âœ“ /root/.local/share/juju removido"
          changed_when: false

        - name: Remove snap directories
          shell: |
            rm -rf /snap/juju* 2>&1 || true
            rm -rf /var/snap/juju* 2>&1 || true
            echo "âœ“ /snap/juju* e /var/snap/juju* removidos"
          changed_when: false

        - name: Remove any remaining Juju config
          shell: |
            rm -rf /etc/juju* 2>&1 || true
            rm -rf ~/.ssh/juju* 2>&1 || true
            echo "âœ“ Arquivos de configuraÃ§Ã£o Juju removidos"
          changed_when: false

        - name: Verify directories are removed
          shell: |
            if [ -d /var/lib/juju ] || [ -d /home/serpro/.local/share/juju ]; then
              echo "âŒ ERRO: Alguns diretÃ³rios ainda existem!"
              ls -la /var/lib/juju 2>/dev/null || true
              ls -la /home/serpro/.local/share/juju 2>/dev/null || true
              exit 1
            fi
                        echo "âœ“ Todos os diretÃ³rios de dados foram removidos"
                      changed_when: false
                tags: remove_data

    # ============================================ 
    # 4. CLEAN JUJU AGENT FILES
    # ============================================ 
    - name: ðŸ”´ PASSO 4 - Clean Juju Agent Files
      block:
        - name: Remove agent files
          shell: |
            rm -rf /var/log/juju* 2>&1 || true
            rm -rf /tmp/juju* 2>&1 || true
            rm -rf ~/.juju 2>&1 || true
            echo "âœ“ Arquivos de agente removidos"
          changed_when: false

        - name: Remove sockets and locks
          shell: |
            rm -f /tmp/.juju* 2>&1 || true
            rm -f /var/run/juju* 2>&1 || true
                        echo "âœ“ Sockets e locks removidos"
                      changed_when: false
                tags: clean_agent_files

    # ============================================ 
    # 5. CLEAN CLOUD-INIT & SYSTEM
    # ============================================ 
    - name: ðŸ”´ PASSO 5 - Clean System
      block:
        - name: Clean cloud-init
          shell: |
            cloud-init clean --logs --seed 2>&1 || true
            echo "âœ“ cloud-init limpo"
          changed_when: false

        - name: Clean package cache
          shell: |
            apt-get clean 2>&1 || true
            apt-get autoclean 2>&1 || true
                        echo "âœ“ Cache de pacotes limpo"
                      changed_when: false
                tags: clean_system
                  become: yes

    # ============================================ 
    # 6. VERIFY CLEAN STATE
    # ============================================ 
    - name: ðŸŸ¢ VERIFICAÃ‡ÃƒO FINAL - Estado Limpo
      block:
        - name: Verify no juju processes
          shell: |
            if pgrep -f jujud > /dev/null; then
              echo "âŒ ERRO: Ainda hÃ¡ processos jujud!"
              exit 1
            fi
            if pgrep -f mongod > /dev/null; then
              echo "âŒ ERRO: Ainda hÃ¡ processos mongod!"
              exit 1
            fi
            echo "âœ“ Nenhum processo Juju rodando"
          changed_when: false

        - name: Verify directories removed
          shell: |
            if [ -d /var/lib/juju ]; then
              echo "âŒ ERRO: /var/lib/juju ainda existe!"
              exit 1
            fi
            if [ -d /home/serpro/.local/share/juju ]; then
              echo "âŒ ERRO: ~/.local/share/juju ainda existe!"
              exit 1
            fi
            echo "âœ“ Todos os diretÃ³rios foram removidos"
          changed_when: false

        - name: Display cleanup summary
          debug:
            msg: |
              â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
              â•‘          âœ… LIMPEZA NUCLEAR CONCLUÃDA COM SUCESSO            â•‘
              â•‘                                                               
              â•‘  Host: {{ inventory_hostname }}                              â•‘
              â•‘  Timestamp: {{ ansible_date_time.iso8601 }}                  â•‘
              â•‘                                                               
              â•‘  âœ“ Todos os processos Juju killados                          â•‘
              â•‘  âœ“ Snap juju removido                                        â•‘
              â•‘  âœ“ Todos os diretÃ³rios de dados removidos                    â•‘
              â•‘  âœ“ Arquivos de configuraÃ§Ã£o removidos                        â•‘
              â•‘  âœ“ Estado do sistema: LIMPO                                  â•‘
              â•‘                                                               
              â•‘  PrÃ³ximo Passo: Executar bootstrap novamente                 â•‘
              â•‘  Comando: ansible-playbook -i inventory playbooks/01-*.yml   â•‘
              â•‘                                                               
              â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    tags: verify_clean

  post_tasks:
    - name: Generate cleanup report
      shell: |
        cat > /tmp/cleanup-report-{{ inventory_hostname }}-$(date +%s).txt << EOF
        JUJU CLEANUP NUCLEAR REPORT
        ===========================
        Generated: $(date -Iseconds)
        Host: {{ inventory_hostname }} 
        
        Cleanup Actions Completed:
        âœ“ All Juju processes killed (-9)
        âœ“ Juju snap removed (--purge)
        âœ“ /var/lib/juju removed
        âœ“ ~/.local/share/juju removed
        âœ“ /snap/juju* removed
        âœ“ /var/snap/juju* removed
        âœ“ Juju config files removed
        âœ“ Agent files cleaned
        âœ“ cloud-init cleaned
        âœ“ Package cache cleaned
        
        System Status: CLEAN
        Ready for new bootstrap: YES
        EOF
        
        echo "Report saved to /tmp/cleanup-report-*.txt"
      changed_when: false
      ignore_errors: true

  handlers:
    - name: system reboot required
      debug:
        msg: "âš ï¸  RECOMENDAÃ‡ÃƒO: Reiniciar o host para garantir limpeza completa"
